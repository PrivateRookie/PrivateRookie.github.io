<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ws-tool 0.5.0 å‘å¸ƒ - å¤œé›¨ç§‹ç¯å½•</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../å¯¼è¨€.html">å¯¼è¨€</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../æ–‡ç« .html"><strong aria-hidden="true">1.</strong> æ–‡ç« </a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../posts/2018-06-24-openstackåˆ›å»ºè™šæ‹Ÿæœºæºç é˜…è¯».html"><strong aria-hidden="true">1.1.</strong> openstackåˆ›å»ºè™šæ‹Ÿæœºæºç é˜…è¯»</a></li><li class="chapter-item expanded "><a href="../../posts/2018-06-27-Bottle-æ¡†æ¶ä¸­è£…é¥°å™¨ç±»å’Œæè¿°ç¬¦åº”ç”¨.html"><strong aria-hidden="true">1.2.</strong> Bottle-æ¡†æ¶ä¸­è£…é¥°å™¨ç±»å’Œæè¿°ç¬¦åº”ç”¨</a></li><li class="chapter-item expanded "><a href="../../posts/2019-04-17-ä½¿ç”¨devpiæ­å»ºæœ¬åœ°æº.html"><strong aria-hidden="true">1.3.</strong> ä½¿ç”¨devpiæ­å»ºæœ¬åœ°æº</a></li><li class="chapter-item expanded "><a href="../../posts/2019-04-20-Pythonå±•å¼€åµŒå¥—åºåˆ—.html"><strong aria-hidden="true">1.4.</strong> Pythonå±•å¼€åµŒå¥—åºåˆ—</a></li><li class="chapter-item expanded "><a href="../../posts/2019-04-20-pipenv-ä½¿ç”¨ç®€ä»‹.html"><strong aria-hidden="true">1.5.</strong> pipenv-ä½¿ç”¨ç®€ä»‹</a></li><li class="chapter-item expanded "><a href="../../posts/2019-04-22-æ·±åº¦ç³»ç»Ÿrustå¼€å‘ç¯å¢ƒæ­å»º.html"><strong aria-hidden="true">1.6.</strong> æ·±åº¦ç³»ç»Ÿrustå¼€å‘ç¯å¢ƒæ­å»º</a></li><li class="chapter-item expanded "><a href="../../posts/2019-05-01-miniserve-miniserveç®€å•ç¾è§‚çš„æ–‡ä»¶æœåŠ¡å™¨.html"><strong aria-hidden="true">1.7.</strong> miniserve-miniserveç®€å•ç¾è§‚çš„æ–‡ä»¶æœåŠ¡å™¨</a></li><li class="chapter-item expanded "><a href="../../posts/2019-05-05-magnum-stein-release-new-features.html"><strong aria-hidden="true">1.8.</strong> magnum-stein-release-new-features</a></li><li class="chapter-item expanded "><a href="../../posts/2019-05-12-rust-rc.html"><strong aria-hidden="true">1.9.</strong> rust-rc</a></li><li class="chapter-item expanded "><a href="../../posts/2019-05-20-Python-Rust-è¿­ä»£å™¨ç±»æ¯”.html"><strong aria-hidden="true">1.10.</strong> Python-Rust-è¿­ä»£å™¨ç±»æ¯”</a></li><li class="chapter-item expanded "><a href="../../posts/2019-06-28-æ­å»ºetcdæœåŠ¡å‘ç°æœåŠ¡.html"><strong aria-hidden="true">1.11.</strong> æ­å»ºetcdæœåŠ¡å‘ç°æœåŠ¡</a></li><li class="chapter-item expanded "><a href="../../posts/2019-07-03-OpenStackå…è®¸rootç”¨æˆ·ä½¿ç”¨ssh-keyç™»å½•.html"><strong aria-hidden="true">1.12.</strong> OpenStackå…è®¸rootç”¨æˆ·ä½¿ç”¨ssh-keyç™»å½•</a></li><li class="chapter-item expanded "><a href="../../posts/2019-07-06-requirements.txtæ–‡ä»¶æŒ‡å®šä¾èµ–.html"><strong aria-hidden="true">1.13.</strong> requirements.txtæ–‡ä»¶æŒ‡å®šä¾èµ–</a></li><li class="chapter-item expanded "><a href="../../posts/2019-07-10-æˆ‘ç»å¸¸ä½¿ç”¨çš„Rustå°crate.html"><strong aria-hidden="true">1.14.</strong> æˆ‘ç»å¸¸ä½¿ç”¨çš„Rustå°crate</a></li><li class="chapter-item expanded "><a href="../../posts/2019-07-14-Rustæ¨¡å—ä¸æ–‡ä»¶.html"><strong aria-hidden="true">1.15.</strong> Rustæ¨¡å—ä¸æ–‡ä»¶</a></li><li class="chapter-item expanded "><a href="../../posts/2019-07-18-Deepinå®‰è£…Angular10+.html"><strong aria-hidden="true">1.16.</strong> Deepinå®‰è£…Angular10+</a></li><li class="chapter-item expanded "><a href="../../posts/2019-07-25-ä½¿ç”¨OSProfiler.html"><strong aria-hidden="true">1.17.</strong> ä½¿ç”¨OSProfiler</a></li><li class="chapter-item expanded "><a href="../../posts/2019-07-27-windowsä¸Šä½¿ç”¨vscode-remote.html"><strong aria-hidden="true">1.18.</strong> windowsä¸Šä½¿ç”¨vscode-remote</a></li><li class="chapter-item expanded "><a href="../../posts/2019-08-04-ä½¿ç”¨rust-analyzer.html"><strong aria-hidden="true">1.19.</strong> ä½¿ç”¨rust-analyzer</a></li><li class="chapter-item expanded "><a href="../../posts/2019-08-16-Python-packageå®‰è£…æ—¶å®‰è£…é¢å¤–æ–‡ä»¶.html"><strong aria-hidden="true">1.20.</strong> Python-packageå®‰è£…æ—¶å®‰è£…é¢å¤–æ–‡ä»¶</a></li><li class="chapter-item expanded "><a href="../../posts/2019-08-31-Rust-å‘½ä»¤è¡Œå·¥å…·.html"><strong aria-hidden="true">1.21.</strong> Rust-å‘½ä»¤è¡Œå·¥å…·</a></li><li class="chapter-item expanded "><a href="../../posts/2019-09-27-Fedora-CoreOS-å°é²œ.html"><strong aria-hidden="true">1.22.</strong> Fedora-CoreOS-å°é²œ</a></li><li class="chapter-item expanded "><a href="../../posts/2020-01-31-rustä»£ç é£æ ¼tips.html"><strong aria-hidden="true">1.23.</strong> rustä»£ç é£æ ¼tips</a></li><li class="chapter-item expanded "><a href="../../posts/2020-02-03-log4rs-Rust-logåº“.html"><strong aria-hidden="true">1.24.</strong> log4rs-Rust-logåº“</a></li><li class="chapter-item expanded "><a href="../../posts/2020-02-29-impl-Trait-vs-dyn-Trait.html"><strong aria-hidden="true">1.25.</strong> impl-Trait-vs-dyn-Trait</a></li><li class="chapter-item expanded "><a href="../../posts/2020-03-04-nom-cheatsheet.html"><strong aria-hidden="true">1.26.</strong> nom-cheatsheet</a></li><li class="chapter-item expanded "><a href="../../posts/2020-03-09-gitlab-runnerå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹.html"><strong aria-hidden="true">1.27.</strong> gitlab-runnerå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹</a></li><li class="chapter-item expanded "><a href="../../posts/2020-03-21-ä½¿ç”¨nomå†™parser.html"><strong aria-hidden="true">1.28.</strong> ä½¿ç”¨nomå†™parser</a></li><li class="chapter-item expanded "><a href="../../posts/2020-05-10-ä½¿ç”¨nomå†™parser.html"><strong aria-hidden="true">1.29.</strong> ä½¿ç”¨nomå†™parser</a></li><li class="chapter-item expanded "><a href="../../posts/2020-06-07-ä½¿ç”¨nomå†™parser.html"><strong aria-hidden="true">1.30.</strong> ä½¿ç”¨nomå†™parser</a></li><li class="chapter-item expanded "><a href="../../posts/2020-06-25-Rustå®ç°çš„æ—¥è‡³æ”¶é›†å·¥å…·.html"><strong aria-hidden="true">1.31.</strong> Rustå®ç°çš„æ—¥è‡³æ”¶é›†å·¥å…·</a></li><li class="chapter-item expanded "><a href="../../posts/2020-07-19-typing+pyright-æ›´æ­£ç¡®çš„Pythonä»£ç .html"><strong aria-hidden="true">1.32.</strong> typing+pyright-æ›´æ­£ç¡®çš„Pythonä»£ç </a></li><li class="chapter-item expanded "><a href="../../posts/2020-07-31-boxercrabå‘å¸ƒ.html"><strong aria-hidden="true">1.33.</strong> boxercrabå‘å¸ƒ</a></li><li class="chapter-item expanded "><a href="../../posts/2020-08-16-ä½¿ç”¨nomå†™parser.html"><strong aria-hidden="true">1.34.</strong> ä½¿ç”¨nomå†™parser</a></li><li class="chapter-item expanded "><a href="../../posts/2020-08-30-PowerShellé…ç½®.html"><strong aria-hidden="true">1.35.</strong> PowerShellé…ç½®</a></li><li class="chapter-item expanded "><a href="../../posts/2022-03-12-Intoç‰¹æ€§å®ç°å‚æ•°å¤šæ€çš„æŠ€å·§.html"><strong aria-hidden="true">1.36.</strong> Intoç‰¹æ€§å®ç°å‚æ•°å¤šæ€çš„æŠ€å·§</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../../ç¬”è®°.html"><strong aria-hidden="true">2.</strong> ç¬”è®°</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../notes/rust/2021-10-31-åµŒå¥—è§£æ„.html"><strong aria-hidden="true">2.1.</strong> åµŒå¥—è§£æ„</a></li><li class="chapter-item expanded "><a href="../../notes/rust/2021-11-06-æœªèƒ½ææ—©é‡Šæ”¾çš„RefCell.html"><strong aria-hidden="true">2.2.</strong> æœªæå‰é‡Šæ”¾çš„å¼•ç”¨</a></li><li class="chapter-item expanded "><a href="../../notes/rust/2022-02-09-serdeæ”¶é›†æœªçŸ¥å­—æ®µ.html"><strong aria-hidden="true">2.3.</strong> serdeæ”¶é›†æœªçŸ¥å­—æ®µ</a></li><li class="chapter-item expanded "><a href="../../notes/rust/2022-02-17-ç¼–è¯‘æœŸç¡®å®šæŸä¸ªç±»å‹æ˜¯ä¸æ˜¯Option.html"><strong aria-hidden="true">2.4.</strong> å¦‚ä½•åœ¨ç¼–è¯‘æœŸç¡®å®šæŸä¸ªç±»å‹æ˜¯ä¸æ˜¯ Option</a></li><li class="chapter-item expanded "><a href="../../notes/rust/2022-03-23-ws-toolæ–°ç‰ˆæœ¬å‘å¸ƒ.html" class="active"><strong aria-hidden="true">2.5.</strong> ws-tool 0.5.0 å‘å¸ƒ</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">å¤œé›¨ç§‹ç¯å½•</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ws-tool-050---é¡¹ç›®è®¾è®¡ä¸ä¼˜åŒ–å°ç»“"><a class="header" href="#ws-tool-050---é¡¹ç›®è®¾è®¡ä¸ä¼˜åŒ–å°ç»“">ws-tool 0.5.0 - é¡¹ç›®è®¾è®¡ä¸ä¼˜åŒ–å°ç»“</a></h1>
<p>ä»Šå¤©åœ¨å®Œæˆ ws-tool ä»£ç†æ”¯æŒçš„çš„ <a href="https://github.com/PrivateRookie/ws-tool/pull/15">PR</a> å ws-tool 0.5.0 æ­£å¼å‘å¸ƒ.</p>
<h2 id="é¡¹ç›®ç®€ä»‹"><a class="header" href="#é¡¹ç›®ç®€ä»‹">é¡¹ç›®ç®€ä»‹</a></h2>
<p>ws-tool ä¸€ä¸ª rust å®ç°çš„ websocket åº“, ä½ å¯ä»¥ç”¨å®ƒå®ç° websocket å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯, ws-tool æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥æ¥å£, æ”¯æŒå°†ä¸€ä¸ªè¯»å†™è¿æ¥åˆ†å‰²æˆ read half å’Œ write half, å¯ä»¥å……åˆ†ä½¿ç”¨ tcp çš„å…¨åŒå·¥æ¨¡å¼é€šä¿¡, è€Œä¸” ws-tool ä¹Ÿæ‹¥æœ‰ä¸é”™çš„æ€§èƒ½.</p>
<p>ä½¿ç”¨ cpp uWebSocket æä¾›çš„ load_test å·¥å…·æµ‹è¯•å•çº¿ç¨‹ä¸‹ msg/sec æŒ‡æ ‡, ws-tool çš„åŒæ­¥å¼‚æ­¥æ¥å£æ€§èƒ½æ¯” uWebSocket å’Œ tungstenite éƒ½è¦é«˜.</p>
<table><thead><tr><th>server</th><th>ws-tool</th><th>ws-tool async</th><th>uWebSocket</th><th>tungstenite</th></tr></thead><tbody>
<tr><td>msg/sec</td><td>5150Â±</td><td>5150Â±</td><td>3200Â±</td><td>2850Â±</td></tr>
</tbody></table>
<p>æµ‹è¯•æœºå™¨ä¸º i9-12900k + 32G 3200Mhz ddr4 å†…å­˜.</p>
<p>ws-tool é¡¹ç›®åŠŸèƒ½çŸ©é˜µ</p>
<table><thead><tr><th>IO type</th><th>split</th><th>proxy</th><th>tls</th><th>deflate</th><th>use as client</th><th>use as server</th></tr></thead><tbody>
<tr><td>blocking</td><td>âœ…</td><td>âœ…</td><td>âœ…</td><td>ğŸš§wip</td><td>âœ…</td><td>âœ…</td></tr>
<tr><td>async</td><td>âœ…</td><td>âœ…</td><td>âœ…</td><td>ğŸš§wip</td><td>âœ…</td><td>âœ…</td></tr>
</tbody></table>
<h2 id="é¡¹ç›®æ¥æºä¸apiè®¾è®¡"><a class="header" href="#é¡¹ç›®æ¥æºä¸apiè®¾è®¡">é¡¹ç›®æ¥æºä¸APIè®¾è®¡</a></h2>
<p>ws-tool é¡¹ç›®æ¥æºäºä¹‹å‰åœ¨ä½¿ç”¨ rust å®ç°å¸å®‰ websocket æ¥å£è¡Œæƒ…æ•°æ®æ”¶é›†æ—¶å‘ç°  tungstenite ä¸æ”¯æŒä»£ç†, åœ¨æˆ‘ fork é¡¹ç›®å¹¶å®ç°åŠŸèƒ½å, tungstenite æ²¡æœ‰æ¥å—æˆ‘çš„ PR. 
å› æ­¤å¦‚æœæˆ‘ç»§ç»­ä½¿ç”¨ tungstenite, æˆ‘å¿…é¡»ç»´æŠ¤è‡ªå·±çš„åˆ†æ”¯, é‚£ä¸ºä»€ä¹ˆä¸è‡ªå·±å†™ä¸€ä¸ªå‘¢? è€Œä¸” tungstenite çš„å¼‚æ­¥ç»‘å®šæ¥å£ä¸å¤ªå¥½ç”¨, æˆ‘å¸Œæœ›æœ‰ä¸€ä¸ªæ”¯æŒåŒæ­¥/å¼‚æ­¥æ¥å£, http/socks5 ä»£ç†çš„ websocket åº“,
ws-tool ç”±æ­¤è¯ç”Ÿ.</p>
<p>ä»æœ€åˆ 0.2.0 åˆ° 0.5.0 ç‰ˆæœ¬, ws-tool ç»å†äº†2æ¬¡é‡æ„. åˆç‰ˆ ws-tool åªèƒ½ä¿è¯ websocket åè®®å®ç°æ­£ç¡®, ä½¿ç”¨ tokio/codec å®ç°åè®®è§£æ, å¯¼è‡´æ³›å‹å¤ªå¤š, API éš¾ç”¨.</p>
<p>å› æ­¤ç¬¬ä¸€æ¬¡é‡æ„ä¸»è¦æ–¹å‘æ˜¯è°ƒæ•´ API, æ–¹å‘æˆ–ç›®æ ‡å¦‚ä¸‹</p>
<ul>
<li>
<ol>
<li>æ¢æ‰ tokio-codec, è‡ªå·±ç»´æŠ¤åè®®è§£æçŠ¶æ€, è¿™æ ·çš„å¥½å¤„åœ¨äºå‡å°‘æ³›å‹ä¸”åŒæ­¥/å¼‚æ­¥æ¥å£å¯ä»¥å…±äº«ä»£ç (tokio-codecåªæœ‰å¼‚æ­¥æ¥å£)</li>
</ol>
</li>
<li>
<ol start="2">
<li>æä¾›ä¸€å¥—ç±»ä¼¼çš„, æ¶µç›–æœ€åº•å±‚ frame è¯»å†™, ä¸æœ€å¸¸ç”¨çš„ string, bytes è¯»å†™æ¥å£</li>
</ol>
</li>
<li>
<ol start="3">
<li>å…è®¸ç”¨æˆ·åœ¨å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚, å¤„ç†æœåŠ¡å™¨å“åº”å’ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚æ„é€ æ¶ˆæ¯è§£æå™¨æ—¶ä¼ å…¥å‡½æ•°, è¿™æ ·å¯ä»¥æ–¹ä¾¿ç”¨æˆ·å®šä¹‰æ•°æ®æ”¶å‘è¡Œä¸º(å¦‚è‡ªåŠ¨åˆ‡åŒ…/åˆå¹¶å°åŒ…, é™åˆ¶æœ€å¤§è½½è·, æ˜¯å¦è¿›è¡Œ utf-8 æ ¡éªŒå’Œè‡ªå®šä¹‰æ‰©å±•ç­‰)</li>
</ol>
</li>
</ul>
<p>åœ¨ ws-tool åœ¨ 0.3.0 åŸºæœ¬ä¸Šå®ç°äº†ä¸Šè¿°é‡æ„ç›®æ ‡.</p>
<p>é¦–å…ˆ ws-tool æä¾›äº†ä»ç±»ä¼¼çš„åŒæ­¥/å¼‚æ­¥æ„é€ å’Œæ•°æ®è¯»å†™æ¥å£, ä»¥é¡¹ç›®çš„ example ä¸ºä¾‹.</p>
<p>åŒæ­¥ server æ„é€ å’Œè¯»å†™æ¶ˆæ¯</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut server = ServerBuilder::accept(
    stream,
    default_handshake_handler,
    WsStringCodec::factory,
)
.unwrap();

loop {
    match server.receive() {
        Ok(msg) =&gt; server.send((msg.code, msg.data)).unwrap(),
        Err(e) =&gt; {
            dbg!(e);
            break;
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>å¼‚æ­¥ serer æ„é€ è¯»å†™æ¶ˆæ¯</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut server = ServerBuilder::async_accept(
    stream,
    default_handshake_handler,
    AsyncWsStringCodec::factory,
)
.await
.unwrap();

loop {
    match server.receive().await {
        Ok(msg) =&gt; {
            server.send((msg.code, msg.data)).await.unwrap()
        }
        Err(e) =&gt; {
            dbg!(e);
            break;
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>å¯ä»¥çœ‹åˆ°ä¸¤è€…APIé™¤äº†å¼‚æ­¥æ¥å£æ—¶éœ€è¦ async_accept å’Œ await future, åœ¨ä½¿ç”¨ä¸ŠåŸºæœ¬æ²¡æœ‰åŒºåˆ«.</p>
<p>å¯¹äºæ•°æ®å†™å…¥æ¥å£çš„è®¾è®¡å¯ä»¥æŸ¥çœ‹<a href="https://zhuanlan.zhihu.com/p/480047583">Intoç‰¹æ€§å®ç°å‚æ•°å¤šæ€çš„æŠ€å·§</a>è¿™ç¯‡æ–‡ç« .</p>
<p>åœ¨ builder accept æ—¶å¯ä»¥çœ‹åˆ°é™¤äº† stream è¿˜éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°, è¿™ä¸¤ä¸ªå‚æ•°æ˜¯å®ç°é‡æ„ç›®æ ‡3çš„å…³é”®. å¯¹äº server æ¥è¯´, å®ƒå¯èƒ½ä¼šæ£€æŸ¥ websocket è¯·æ±‚ header ä¹‹å¤–é¢å¤–çš„ header, å¹¶å†³å®š server æ˜¯å¦æ¥å— upgrade è¯·æ±‚.</p>
<p>å¦‚æœæŸ¥çœ‹ç¬¬äºŒä¸ªå‚æ•°çš„ç±»å‹, å¯ä»¥å‘ç°è¿™æ˜¯ä¸€ä¸ª <code>Fn(http::Request&lt;()&gt;) -&gt; Result&lt;(http::Request&lt;()&gt;, http::Response&lt;T&gt;), WsError&gt;</code>, å³å‚æ•°ä¸º client æ¡æ‰‹è¯·æ±‚, å¹¶è¿”å›è¯¥è¯·æ±‚(åç»­æ„å»ºcodecæ—¶è¿˜éœ€è¦)å’Œresponse. ç”¨
æˆ·åªè¦ä¼ å…¥ç¬¦åˆç­¾åçš„å‡½æ•°å³å®ç°è‡ªå®šä¹‰æ¡æ‰‹è¯·æ±‚å¤„ç†é€»è¾‘. å½“ç„¶ä¸ºäº†ä½¿ç”¨ç®€ä¾¿, ws-tool æä¾›äº† default_handshake_handler å‡½æ•°ä»¥åº”å¯¹å¤§å¤šæ•°æƒ…å†µ.</p>
<p>ç¬¬ä¸‰ä¸ªå‚æ•°ç±»å‹ä¸º <code>Fn(http::Request&lt;()&gt;, WsStream&lt;S&gt;) -&gt; Result&lt;C, WsError&gt;</code>, è¿™ä¸ªå‡½æ•°æ¥å— client æ¡æ‰‹è¯·æ±‚(å¯èƒ½åŒ…å«è®¤è¯ä¿¡æ¯ç­‰å…¶ä»–æœ‰ç”¨ä¿¡æ¯)ä»¥åŠå·²ç»æŠŠç¬¬äºŒä¸ªå‚æ•°è¿”å›è¿”å›ä¸ªclientçš„ stream, å³å·²ç»å®Œæˆæ¡æ‰‹çš„ stream, ä½ å¯ä»¥åœ¨ä¸Šé¢è¯»å†™ websocket frame. ç”¨æˆ·å¯ä»¥åœ¨ stream ä¸ŠåŒ…è£…è‡ªå·±é€»è¾‘, å®ç°è‡ªå®šä¹‰çš„ codec, å¦‚æ ¹æ® header è§£å¯† bytes ä¿¡æ¯ç­‰.</p>
<p>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨, ws-tool æä¾›äº† FrameCodec, StringCodec, BytesCodec ä¸‰ç§æœ€åŸºæœ¬ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ codec, é€šè¿‡å®ƒä»¬, ç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„è¯»å†™æœ€åŸå§‹çš„ frame, æˆ–è€…æ›´é«˜çº§çš„ text/bytes.</p>
<h2 id="æ€§èƒ½ä¼˜åŒ–"><a class="header" href="#æ€§èƒ½ä¼˜åŒ–">æ€§èƒ½ä¼˜åŒ–</a></h2>
<p>æœ‰äº†ç›¸å¯¹å¥½ç”¨çš„ API, ä¸‹ä¸€æ­¥æ˜¯æ€§èƒ½. åœ¨æœ€åˆçš„æµ‹è¯•é‡Œ, ws-tool æ˜¯æ‰€æœ‰æ¯”è¾ƒå¯¹è±¡ä¸­æ€§èƒ½æœ€ä½çš„. ä½¿ç”¨ cargo-flamegraph profile ä¹‹åå‘ç°ä¸¤ä¸ªä¸»è¦çš„æ€§èƒ½ç“¶é¢ˆ, åˆ†åˆ«æ˜¯</p>
<ol>
<li>æœ‰å¤šæ¬¡æ•°æ® copy, ç‰¹åˆ«æ˜¯ load_test çš„ payload ç›¸å¯¹æ¯”è¾ƒå¤§, å¤šæ¬¡ copy å¸¦æ¥ä¸å°‘æ€§èƒ½æŸè€—.</li>
<li>mask æ•°æ®å®ç°æ€§èƒ½ä½ä¸‹, åœ¨å¤§ payload ä¸‹ä¸¥é‡æ‹–ç´¯æ€§èƒ½.</li>
</ol>
<p>æœ‰äº†ç›®æ ‡å, å°±å¯ä»¥ç€æ‰‹è¿›è¡Œä¼˜åŒ–. </p>
<p>ä¸ºäº†å‡å°‘æ•°æ® copy, ws-tool åœ¨è¯»å†™æ—¶ä¸å†å…ˆå†™å…¥å›ºå®šå¤§å°çš„ buffer, è€Œæ˜¯åˆ©ç”¨ BytesMut çš„ API, æ“ä½œ len, è®°å½•åç§»é‡ç­‰æ–¹å¼å°†æ•°æ®ç›´æ¥å†™å…¥ frame åº•å±‚ buffer ä¸­, å…·ä½“å®ç°å¯ä»¥å‚è€ƒé¡¹ç›®ä»£ç . ä½†è¿™æ ·åšåœ¨å†™å…¥ frame æ—¶åˆä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜, è¿™ç§ frame éœ€è¦&quot;æ‹¥æœ‰&quot;æ•°æ®(BytesMutç‹¬å æ‰€æœ‰æƒ), ä½†å¯¹äº server ç«¯, å› ä¸ºå…¶ä¸éœ€è¦ mask payload çš„ç‰¹æ€§, æä¾›ä¸€ä¸ª <code>&amp;[u8]</code> ç”šè‡³ <code>Vec&lt;&amp;[u8]&gt;</code> ç±»å‹çš„ payload æ˜¾ç„¶é™åˆ¶æ›´å°‘, ç”¨ç€æ›´æ–¹ä¾¿, è€Œä¸”é¿å…äº†æŠŠæ•°æ® copy åˆ° BytesMut çš„æ€§èƒ½æŸè€—.</p>
<p>æ‰€ä»¥ ws-tool åˆå¯¹åº•å±‚ Frame æ•°æ®ç±»å‹è¿›è¡Œäº†ä¸€æ¬¡é‡æ„, ç›®å‰å…±åˆ†å‡ºä¸‰ç§ frame</p>
<ul>
<li>ReadFrame, åº•å±‚æ˜¯ä¸€ä¸ª BytesMut, æ¥è‡ªäºä» stream è¯»åˆ°çš„ frame, frame å¤šå¤§å°±å¤šå¤§, æ²¡æœ‰å ç”¨é¢å¤–ç©ºé—´å­˜å‚¨ä¿¡æ¯.</li>
<li>BorrowedFrame, æœ‰ FrameHeader å’Œ <code>Vec&lt;&amp;[u8]&gt;</code> ç»„æˆ, æ²¡æœ‰ payload æ‰€æœ‰æƒ, å¤šæ•°æƒ…å†µç”¨äºå†™å…¥</li>
<li>OwnedFrame, åº•å±‚æ˜¯ header å’Œ payload, æ‹¥æœ‰ payload æ‰€æœ‰æƒ(éƒ½æ˜¯ BytesMut), è¿™ä¸ªç±»å‹æ˜¯ä¸ºäº†ç»™ç”¨æˆ·æ“ä½œåº•å±‚ frame æ•°æ®æä¾›æ–¹ä¾¿çš„æ¥å£</li>
</ul>
<p>è‡³äº mask å¯ä»¥ç›´æ¥å°† tungstenite å®ç° copy è¿‡æ¥. ä»¥åå¯ä»¥è€ƒè™‘ä½¿ç”¨ std::simd æ¥æä¾› portable simd åŠ é€Ÿ, ç†è®ºä¸Šèƒ½æä¾›æ›´å¥½çš„ mask æ€§èƒ½.</p>
<p>æœ€åçš„æµ‹è¯•ç»“æœè¡¨æ˜, è¿™äº›ä¼˜åŒ–éå¸¸æœ‰æ•ˆ, ç°åœ¨ ws-tool æ€§èƒ½æ˜¯æœ€å¥½çš„.</p>
<h2 id="å›å½’åˆå¿ƒ"><a class="header" href="#å›å½’åˆå¿ƒ">å›å½’åˆå¿ƒ</a></h2>
<p>ws-tool æœ€åˆç›®æ ‡ä¹‹ä¸€æ˜¯æ”¯æŒ proxy, å¯æƒœ crates.io ä¸­ http/socks5 ä»£ç†ç»å¤§éƒ¨åˆ†åªæ”¯æŒ async, å¯¼è‡´ ws-tool åœ¨åŒæ­¥æ¥å£ä¸­æ— æ³•ä½¿ç”¨ proxy. ä¸ºæ­¤æˆ‘åˆå®ç°äº† <a href="https://github.com/PrivateRookie/proxy">http/socks5 ä»£ç†å®¢æˆ·ç«¯</a>, å¹¶å‘å¸ƒåœ¨ crates.io ä¸Š.</p>
<p>è‡ªæ­¤, ws-tool å·²ç»å®ç° sync/async æ¥å£é™¤ deflate æ‰©å±•å¤–çš„è®¾è®¡ç›®æ ‡.</p>
<h2 id="æ€»ç»“"><a class="header" href="#æ€»ç»“">æ€»ç»“</a></h2>
<p>æ„Ÿè§‰æ²¡ä»€ä¹ˆå¥½æ€»ç»“çš„, è®¾è®¡å’Œå®ç°éƒ½åœ¨ä»£ç é‡Œ, å¦‚æœè§‰å¾—æ–‡ç« æˆ–é¡¹ç›®æœ‰ç”¨è¯·ç‚¹ä¸ªèµæˆ– star ä¸€ä¸‹.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../notes/rust/2022-02-17-ç¼–è¯‘æœŸç¡®å®šæŸä¸ªç±»å‹æ˜¯ä¸æ˜¯Option.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../notes/rust/2022-02-17-ç¼–è¯‘æœŸç¡®å®šæŸä¸ªç±»å‹æ˜¯ä¸æ˜¯Option.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        
        <!-- Google Analytics Tag -->
        <script type="text/javascript">
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-138690523-1', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../lunr.zh.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
